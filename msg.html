<html>
  <head>
    <title>Handheld App</title>
    <link rel="stylesheet" href="./css/vehicle.css" />
    <link rel="stylesheet" href="./css/main.css" />
    <link rel="stylesheet" href="./js/leaflet/leaflet.css" />
    <!--[if lte IE 8]>
      <link rel="stylesheet" src="./css/leaflet.ie.css" />
    <![endif]-->
    <script type="text/javascript" src="./js/webinos.js"></script>
    <script type="text/javascript" src="./js/leaflet/leaflet.js"></script>
    <script type="text/javascript" src="./js/jquery-1.8.2.min.js"></script>
    <script type="text/javascript" src="./js/tum.gr-logistics.messaging.js"></script>
    <script type="text/javascript">
      $(document).ready(function () {
      
        var messaging;
        
        //listener ensures, that the webinos.session object is initialized.
        webinos.session.addListener('registeredBrowser', function () {
          messaging = new GRMessaging(function() {
            messaging.searchChannel();
          }, function(message) {
            console.log("== Received message!");
            handleMessage(message);
          });
          findServices();
        });
      
        var handleMessage = function(message) {
          if(typeof messaging !== "undefined" && messaging.isReceiver(message.contents)) {
            var messageHtml = messaging.getFormattedMessage(message.contents);
            $('#msg_receive').append(messageHtml + "<br>");
          }
        }
        
        function serviceIsFromPZP(id) {
          if (id.split("/") && id.split("/").length === 2) {
            return true;
          } else  {
            return false;
          }
        }
        
        function findServices() {
          webinos.discovery.findServices(new ServiceType('http://webinos.org/api/test'), {
            onFound: function (service) {
              console.log('Found service: ' + service.serviceAddress);
              if(serviceIsFromPZP(service.serviceAddress) && service.serviceAddress != webinos.session.getPZPId()) {
                $('#receivers').append($('<option value=' + service.serviceAddress + '>' + service.serviceAddress + '</option>'));						
              }
            }
          });
        }

        $('#btn_send_broadcast').click(function(){messaging.sendBroadcast(
          webinos.session.getPZPId(),
          $('#msg_send').val(),
          function(success) {
            $('#msg_send').val('');
          },
          function(error) {
              alert("Could not send message: " + error.message);
          });
        });
    
        $('#btn_send_unicast').click(function(){
          messaging.sendMessageTo(
            webinos.session.getPZPId(),
            $('#receivers').val(),
            $('#msg_send').val(),
          function(success) {
            $('#msg_send').val('');
          },
          function(error) {
              alert("Could not send message: " + error.message);
          });
        });
        
        $('#btn_reconnect').click(function(){connectToNextChannel();});

      });
    </script>
  </head>
  <body>
    <h1>Handheld App</h1>
    <div id="messaging">
      <h3>Outgoing message:</h3>
      <textarea id="msg_send" class="message">Hello World!</textarea>
      <div style="margin:10px;">
        <label>Receiver:</label>
        <select id="receivers" class="select" label="Receiver:"></select>
      </div>
      <input type="button" id="btn_send_broadcast" value="Send broadcast">
      <input type="button" id="btn_send_unicast" value="Send to">
      <input type="button" id="btn_reconnect" value="Reconnect">
      <h3>Incoming messages:</h3>
      <div id="msg_receive" class="message"></div>
      <input type="button" id="btn_clr_received" value="Clear">
    </div>
  </body>
</html>
